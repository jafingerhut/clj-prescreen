From 2ccebbc90d8d981d8670767d12159cc28c362b0f Mon Sep 17 00:00:00 2001
From: Steve Miner <steveminer@gmail.com>
Date: Fri, 20 Apr 2012 13:55:12 -0400
Subject: [PATCH] CLJ-844 NPE calling keyword on map from bean

---
 src/clj/clojure/core_proxy.clj             |    2 +-
 test/clojure/test_clojure/java_interop.clj |    5 +++++
 2 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/src/clj/clojure/core_proxy.clj b/src/clj/clojure/core_proxy.clj
index 830f5ce..b867d6b 100644
--- a/src/clj/clojure/core_proxy.clj
+++ b/src/clj/clojure/core_proxy.clj
@@ -394,7 +394,7 @@
            []
       (containsKey [k] (contains? pmap k))
       (entryAt [k] (when (contains? pmap k) (new clojure.lang.MapEntry k (v k))))
-      (valAt ([k] (v k))
+      (valAt ([k] (when (contains? pmap k) (v k)))
 	     ([k default] (if (contains? pmap k) (v k) default)))
       (cons [m] (conj (snapshot) m))
       (count [] (count pmap))
diff --git a/test/clojure/test_clojure/java_interop.clj b/test/clojure/test_clojure/java_interop.clj
index 55ab50f..f80d0e4 100644
--- a/test/clojure/test_clojure/java_interop.clj
+++ b/test/clojure/test_clojure/java_interop.clj
@@ -123,6 +123,11 @@
         (:alpha b) 255
         (:transparency b) 1
 
+        (:missing b) nil
+        (:missing b :default) :default
+        (get b :missing) nil
+        (get b :missing :default) :default
+
         (:class b) java.awt.Color )))
 
 
-- 
1.7.4.1

