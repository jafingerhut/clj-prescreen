From 05ba5aef69ab20574ce5c59f1cc527691ec50dbd Mon Sep 17 00:00:00 2001
From: Stuart Sierra <mail@stuartsierra.com>
Date: Tue, 25 Oct 2011 19:22:21 -0400
Subject: [PATCH] clojure.test: Run :each fixtures inside test-var, not test-all-vars; refs CLJ-840

Makes *testing-vars* visible to :each fixture functions
---
 src/clj/clojure/test.clj |   23 ++++++++++++-----------
 1 files changed, 12 insertions(+), 11 deletions(-)

diff --git a/src/clj/clojure/test.clj b/src/clj/clojure/test.clj
index 2725e20..5dd2bff 100644
--- a/src/clj/clojure/test.clj
+++ b/src/clj/clojure/test.clj
@@ -683,30 +683,31 @@
 
 (defn test-var
   "If v has a function in its :test metadata, calls that function,
-  with *testing-vars* bound to (conj *testing-vars* v)."
+  wrapped in :each fixtures, with *testing-vars* bound to
+  (conj *testing-vars* v)."
   {:dynamic true, :added "1.1"}
   [v]
   (when-let [t (:test (meta v))]
     (binding [*testing-vars* (conj *testing-vars* v)]
-      (do-report {:type :begin-test-var, :var v})
-      (inc-report-counter :test)
-      (try (t)
-           (catch Throwable e
-             (do-report {:type :error, :message "Uncaught exception, not in assertion."
-                      :expected nil, :actual e})))
-      (do-report {:type :end-test-var, :var v}))))
+      (let [each-fixture-fn (join-fixtures (::each-fixtures (meta (:ns (meta v)))))]
+        (do-report {:type :begin-test-var, :var v})
+        (inc-report-counter :test)
+        (try (each-fixture-fn t)
+             (catch Throwable e
+               (do-report {:type :error, :message "Uncaught exception, not in assertion."
+                           :expected nil, :actual e})))
+        (do-report {:type :end-test-var, :var v})))))
 
 (defn test-all-vars
   "Calls test-var on every var interned in the namespace, with fixtures."
   {:added "1.1"}
   [ns]
-  (let [once-fixture-fn (join-fixtures (::once-fixtures (meta ns)))
-        each-fixture-fn (join-fixtures (::each-fixtures (meta ns)))]
+  (let [once-fixture-fn (join-fixtures (::once-fixtures (meta ns)))]
     (once-fixture-fn
      (fn []
        (doseq [v (vals (ns-interns ns))]
          (when (:test (meta v))
-           (each-fixture-fn (fn [] (test-var v)))))))))
+           (test-var v)))))))
 
 (defn test-ns
   "If the namespace defines a function named test-ns-hook, calls that.
-- 
1.7.4.1

