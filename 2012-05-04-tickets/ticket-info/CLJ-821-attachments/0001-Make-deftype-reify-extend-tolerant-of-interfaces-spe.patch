From dc5892ac47ac73815ee567e8edd2f3dd3bd7514b Mon Sep 17 00:00:00 2001
From: Alan Malloy <alan@malloys.org>
Date: Tue, 19 Jul 2011 23:30:42 -0700
Subject: [PATCH] Make deftype/reify/extend tolerant of interfaces specified multiple times.

---
 src/clj/clojure/core_deftype.clj        |    2 +-
 test/clojure/test_clojure/protocols.clj |    9 +++++++++
 2 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/src/clj/clojure/core_deftype.clj b/src/clj/clojure/core_deftype.clj
index 84d11ab..a16c2b6 100644
--- a/src/clj/clojure/core_deftype.clj
+++ b/src/clj/clojure/core_deftype.clj
@@ -38,7 +38,7 @@
 (defn- parse-impls [specs]
   (loop [ret {} s specs]
     (if (seq s)
-      (recur (assoc ret (first s) (take-while seq? (next s)))
+      (recur (update-in ret [(first s)] into (take-while seq? (next s)))
              (drop-while seq? (next s)))
       ret)))
 
diff --git a/test/clojure/test_clojure/protocols.clj b/test/clojure/test_clojure/protocols.clj
index 542ebfd..8c2fc48 100644
--- a/test/clojure/test_clojure/protocols.clj
+++ b/test/clojure/test_clojure/protocols.clj
@@ -546,3 +546,12 @@
         (is (= 2 (.hinted r 1)))
         (is (= "xoxo" (.hinted r "xo")))))))
 
+(deftype FragmentedMapEntry [k v]
+  java.util.Map$Entry (getKey [this] k)
+  java.util.Map$Entry (getValue [this] v))
+
+(deftest fragmented-deftype
+  (testing "Can specify an interface twice in a deftype"
+    (let [entry (FragmentedMapEntry. :k :v)]
+      (is (= :k (.getKey entry)))
+      (is (= :v (.getValue entry))))))
-- 
1.7.0.4

